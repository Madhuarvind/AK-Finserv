# Add this route to customer.py after the sync route

@customer_bp.route('/create', methods=['POST'])
@jwt_required()
def create_customer_online():
    """Create customer directly on server (for web/online mode)"""
    print("=== CREATE CUSTOMER ONLINE ===")
    identity = get_jwt_identity()
    user = User.query.filter((User.mobile_number == identity) | (User.username == identity) | (User.id == identity)).first()
    
    if not user:
        return jsonify({"msg": "User not found"}), 404

    data = request.get_json()
    print(f"Customer data: {data}")
    
    try:
        # Check for duplicate
        existing = Customer.query.filter_by(mobile_number=data['mobile_number']).first()
        if existing:
            return jsonify({
                "msg": "Customer with this mobile number already exists",
                "customer_id": existing.customer_id
            }), 400

        # Generate Unique Customer ID
        current_year = datetime.now().year
        count = Customer.query.filter(Customer.created_at >= datetime(current_year, 1, 1)).count()
        cust_unique_id = f"CUST-{current_year}-{str(count + 1).zfill(6)}"
        
        while Customer.query.filter_by(customer_id=cust_unique_id).first():
            count += 1
            cust_unique_id = f"CUST-{current_year}-{str(count + 1).zfill(6)}"

        new_customer = Customer(
            name=data['name'],
            mobile_number=data['mobile_number'],
            address=data.get('address'),
            area=data.get('area'),
            customer_id=cust_unique_id,
            assigned_worker_id=user.id if user.role == UserRole.FIELD_AGENT else None,
            id_proof_number=data.get('id_proof_number'),
            latitude=data.get('latitude'),
            longitude=data.get('longitude'),
            status='active',
            created_at=datetime.utcnow()
        )
        
        db.session.add(new_customer)
        db.session.commit()
        
        print(f"Customer created: {new_customer.customer_id}")
        
        return jsonify({
            "msg": "Customer created successfully",
            "customer_id": new_customer.customer_id,
            "server_id": new_customer.id
        }), 201
        
    except Exception as e:
        db.session.rollback()
        print(f"Error creating customer: {e}")
        return jsonify({"msg": str(e)}), 500
